"use strict";uBlock.PageStore=function(){var t=uBlock,e=[],i=function(t,e,i){this.init(t,e,i)};i.prototype.init=function(t,e,i){return this.result=t,this.type=e,this.time=Date.now(),this.logData=i,this},i.prototype.dispose=function(){this.result=this.type="",this.logData=void 0,e.length<200&&e.push(this)},i.factory=function(t,o,n){return e.length?e.pop().init(t,o,n):new i(t,o,n)};var o=[],n=function(){this.init()};n.factory=function(){var t=o.pop();return void 0===t?t=new n:t.init(),t},n.prototype.init=function(){this.urls=Object.create(null),this.count=0,this.shelfLife=15e3,this.timer=null,this.boundPruneAsyncCallback=this.pruneAsyncCallback.bind(this)},n.prototype.dispose=function(){return this.empty(),this.boundPruneAsyncCallback=null,o.length<10&&o.push(this),null},n.prototype.add=function(t,e,o){var n=t.requestURL,r=t.requestType,s=r+" "+n,a=this.urls[s];if(void 0!==a)return a.result=e,a.type=r,a.time=Date.now(),void(a.logData=o);this.urls[s]=i.factory(e,r,o),0===this.count&&this.pruneAsync(),this.count+=1},n.prototype.empty=function(){for(var t in this.urls)this.urls[t].dispose();this.urls=Object.create(null),this.count=0,null!==this.timer&&(clearTimeout(this.timer),this.timer=null)},n.prototype.compareEntries=function(t,e){return this.urls[e].time-this.urls[t].time},n.prototype.prune=function(){for(var t,e,i=Object.keys(this.urls).sort(this.compareEntries.bind(this)),o=Date.now()-this.shelfLife,n=i.length;n--&&(t=i[n],!((e=this.urls[t]).time>o));)e.dispose(),delete this.urls[t];this.count-=i.length-n-1,this.count>0&&this.pruneAsync()},n.prototype.pruneAsync=function(){null===this.timer&&(this.timer=vAPI.setTimeout(this.boundPruneAsyncCallback,2*this.shelfLife))},n.prototype.pruneAsyncCallback=function(){this.timer=null,this.prune()},n.prototype.lookup=function(t){return this.urls[t.requestType+" "+t.requestURL]||void 0};var r=[],s=function(t){this.init(t)};s.factory=function(t){var e=r.pop();return void 0===e?new s(t):e.init(t)},s.prototype.init=function(e){var i=t.URI;return this.pageHostname=i.hostnameFromURI(e),this.pageDomain=i.domainFromHostname(this.pageHostname)||this.pageHostname,this},s.prototype.dispose=function(){return this.pageHostname=this.pageDomain="",r.length<50&&r.push(this),null};var a=[],u=function(t){this.init(t),this.journal=[],this.journalTimer=null,this.journalLastCommitted=this.journalLastUncommitted=void 0,this.journalLastUncommittedURL=void 0};return u.factory=function(t){var e=a.pop();return void 0===e?e=new u(t):e.init(t),e},u.prototype.init=function(e){var i=t.tabContextManager.mustLookup(e);return this.tabId=e,this.tabHostname=i.rootHostname,this.title=i.rawURL,this.rawURL=i.rawURL,this.hostnameToCountMap=new Map,this.contentLastModified=0,this.frames=Object.create(null),this},u.prototype.reuse=function(e){var i=t.tabContextManager.mustLookup(this.tabId);return i.rootHostname!==this.tabHostname&&(e=""),"tabUpdated"===e?(this.rawURL=i.rawURL,this):(this.disposeFrameStores(),this.netFilteringCache=this.netFilteringCache.dispose(),this.init(this.tabId),this)},u.prototype.dispose=function(){return this.tabHostname="",this.title="",this.rawURL="",this.hostnameToCountMap=null,this.disposeFrameStores(),this.netFilteringCache=this.netFilteringCache.dispose(),null!==this.journalTimer&&(clearTimeout(this.journalTimer),this.journalTimer=null),this.journal=[],this.journalLastUncommittedURL=void 0,a.length<10&&a.push(this),null},u.prototype.disposeFrameStores=function(){var t=this.frames;for(var e in t)t[e].dispose();this.frames=Object.create(null)},u.prototype.getFrame=function(t){return this.frames[t]||null},u.prototype.setFrame=function(t,e){var i=this.frames[t];i?i.init(e):this.frames[t]=s.factory(e)},u.prototype.createContextFromPage=function(){var e=t.tabContextManager.createContext(this.tabId);return e.pageHostname=e.rootHostname,e.pageDomain=e.rootDomain,e},u.prototype.createContextFromFrameId=function(e){var i=t.tabContextManager.createContext(this.tabId),o=this.frames[e];return o?(i.pageHostname=o.pageHostname,i.pageDomain=o.pageDomain):(i.pageHostname=i.rootHostname,i.pageDomain=i.rootDomain),i},u.prototype.createContextFromFrameHostname=function(e){var i=t.tabContextManager.createContext(this.tabId);return i.pageHostname=e,i.pageDomain=t.URI.domainFromHostname(e)||e,i},u.prototype.getNetFilteringSwitch=function(){return t.tabContextManager.mustLookup(this.tabId).getNetFilteringSwitch()},u.prototype.getSpecificCosmeticFilteringSwitch=function(){return!0!==this.noCosmeticFiltering},u.prototype.getGenericCosmeticFilteringSwitch=function(){return!0!==this.noGenericCosmeticFiltering&&!0!==this.noCosmeticFiltering},u.prototype.toggleNetFilteringSwitch=function(e,i,o){t.toggleNetFilteringSwitch(e,i,o),this.netFilteringCache.empty()},u.prototype.journalAddRequest=function(t,e){""!==t&&(this.journal.push(t,1===e?1:65536),null===this.journalTimer&&(this.journalTimer=vAPI.setTimeout(this.journalProcess.bind(this,!0),1e3)))},u.prototype.journalAddRootFrame=function(t,e){"committed"===t?(this.journalLastCommitted=this.journal.length,void 0!==this.journalLastUncommitted&&this.journalLastUncommitted<this.journalLastCommitted&&this.journalLastUncommittedURL===e&&(this.journalLastCommitted=this.journalLastUncommitted,this.journalLastUncommitted=void 0)):"uncommitted"===t&&(this.journalLastUncommitted=this.journal.length,this.journalLastUncommittedURL=e),null!==this.journalTimer&&clearTimeout(this.journalTimer),this.journalTimer=vAPI.setTimeout(this.journalProcess.bind(this,!0),1e3)},u.prototype.journalProcess=function(e){e||clearTimeout(this.journalTimer),this.journalTimer=null;var i,o,n,r,s=this.journal,a=s.length,u=0,h=Date.now(),l=this.journalLastCommitted||0;for(i=l;i<a;i+=2)o=s[i],void 0===(r=this.hostnameToCountMap.get(o))&&(r=0,this.contentLastModified=h),n=s[i+1],this.hostnameToCountMap.set(o,r+n),u+=n;for(this.perLoadBlockedRequestCount+=65535&u,this.journalLastCommitted=void 0,65535&u&&t.userSettings.showIconBadge&&t.updateBadgeAsync(this.tabId),i=0;i<l;i+=2)u+=s[i+1];0!==u&&(t.localSettings.blockedRequestCount+=65535&u,t.localSettingsLastModified=h),s.length=0},u.prototype.filterRequest=function(e){this.logData=void 0;var i=e.requestType;if(-1==="image media object sub_frame".indexOf(i))return this.filterRequestNoCache(e);var o=t.tabContextManager.mustLookup(this.tabId).rawURL;if(o.indexOf("youtube.com")>-1){var n=this.getNetFilteringSwitch();if("no-block-ads-on-this-channel"===adawareYoutube.filterRequest(o,n))return this.netFilteringCache.add(e,""),""}if(!1===this.getNetFilteringSwitch())return this.netFilteringCache.add(e,0),0;var r=this.netFilteringCache.lookup(e);if(void 0!==r)return this.logData=r.logData,r.result;var s=0;return 0!==s&&3!==s||0!==(s=t.staticNetFilteringEngine.matchString(e))&&(this.logData=t.staticNetFilteringEngine.toLogData()),this.netFilteringCache.add(e,s,this.logData),s},u.prototype.filterRequestNoCache=function(e){this.logData=void 0;var i=t.tabContextManager.mustLookup(this.tabId).rawURL;if(i.indexOf("youtube.com")>-1){var o=this.getNetFilteringSwitch();if("no-block-ads-on-this-channel"===adawareYoutube.filterRequest(i,o))return""}if(!1===this.getNetFilteringSwitch())return 0;if("csp_report"===e.requestType&&0!==this.internalRedirectionCount)return this.logData={result:1,source:"global",raw:"no-spurious-csp-report"},1;var n=0;return 0!==n&&3!==n||0!==(n=t.staticNetFilteringEngine.matchString(e))&&(this.logData=t.staticNetFilteringEngine.toLogData()),n},u.prototype.logBlockedRequestsStats=function(t,e){if(1===t)switch(e){case"ads":this.perLoadCategorizedBlockedRequestCount.ads++;break;case"privacy":this.perLoadCategorizedBlockedRequestCount.privacy++;break;default:this.perLoadCategorizedBlockedRequestCount.other++}},{factory:u.factory}}();