!function(){"use strict";var t,e=uBlock;e.normalizePageURL=function(t,e){if(vAPI.isBehindTheSceneTabId(t))return"http://behind-the-scene/";var i=this.URI.set(e),n=i.scheme;if("https"===n||"http"===n)return i.normalizedURI();var o=n+"-scheme";return""!==i.hostname?o=i.hostname+"."+o:"about"===n&&""!==i.path&&(o=i.path+"."+o),"http://"+o+"/"},e.tabContextManager=function(){var t=Object.create(null),i="",n=0,o=Object.create(null),s=function(t,e){this.targetTabId=t,this.openerTabId=e,this.selfDestructionTimer=null,this.launchSelfDestruction()};s.prototype.destroy=function(){null!==this.selfDestructionTimer&&clearTimeout(this.selfDestructionTimer),delete o[this.targetTabId]},s.prototype.launchSelfDestruction=function(){null!==this.selfDestructionTimer&&clearTimeout(this.selfDestructionTimer),this.selfDestructionTimer=vAPI.setTimeout(this.destroy.bind(this),1e4)};var r=function(t){var e,i=o;for(var n in i)e=i[n],t!==n&&t!==e.openerTabId||(!0===vAPI.tabs.onPopupUpdated(n,e.openerTabId)?e.destroy():e.launchSelfDestruction())};vAPI.tabs.onPopupCreated=function(t,e){void 0===o[t]&&(o[t]=new s(t,e)),r(t)};var a=function(t,e){this.url=t,this.committed=e,this.tstamp=Date.now()},h=function(e){this.tabId=e.toString(),this.stack=[],this.rawURL=this.normalURL=this.rootHostname=this.rootDomain="",this.commitTimer=null,this.gcTimer=null,this.onGCBarrier=!1,this.netFiltering=!0,this.netFilteringReadTime=0,t[e]=this};h.prototype.destroy=function(){vAPI.isBehindTheSceneTabId(this.tabId)||(null!==this.gcTimer&&(clearTimeout(this.gcTimer),this.gcTimer=null),delete t[this.tabId])},h.prototype.onTab=function(t){t?this.gcTimer=vAPI.setTimeout(this.onGC.bind(this),6e5):this.destroy()},h.prototype.onGC=function(){vAPI.isBehindTheSceneTabId(this.tabId)||this.onGCBarrier||(this.onGCBarrier=!0,this.gcTimer=null,vAPI.tabs.get(this.tabId,this.onTab.bind(this)),this.onGCBarrier=!1)},h.prototype.onCommit=function(){if(!vAPI.isBehindTheSceneTabId(this.tabId)){this.commitTimer=null;for(var t=this.stack.length;t--&&!this.stack[t].committed;);-1===t&&0!==this.stack.length&&(this.stack[0].committed=!0,t=0),(t+=1)<this.stack.length&&(this.stack.length=t,this.update())}},h.prototype.autodestroy=function(){vAPI.isBehindTheSceneTabId(this.tabId)||(this.gcTimer=vAPI.setTimeout(this.onGC.bind(this),6e5))},h.prototype.update=function(){if(this.netFilteringReadTime=0,0!==this.stack.length){var t=this.stack[this.stack.length-1];this.rawURL=t.url,this.normalURL=e.normalizePageURL(this.tabId,this.rawURL),this.rootHostname=e.URI.hostnameFromURI(this.normalURL),this.rootDomain=e.URI.domainFromHostname(this.rootHostname)||this.rootHostname}else this.rawURL=this.normalURL=this.rootHostname=this.rootDomain=""},h.prototype.push=function(t){if(!vAPI.isBehindTheSceneTabId(this.tabId)){var e=this.stack.length;0!==e&&this.stack[e-1].url===t||(this.stack.push(new a(t)),this.update(),r(this.tabId),null!==this.commitTimer&&clearTimeout(this.commitTimer),this.commitTimer=vAPI.setTimeout(this.onCommit.bind(this),500))}},h.prototype.commit=function(t){vAPI.isBehindTheSceneTabId(this.tabId)||(this.stack=[new a(t,!0)],this.update())},h.prototype.getNetFilteringSwitch=function(){return this.netFilteringReadTime>e.netWhitelistModifyTime?this.netFiltering:(this.netFiltering=e.getNetFilteringSwitch(this.normalURL),this.netFiltering&&this.rawURL!==this.normalURL&&""!==this.rawURL&&(this.netFiltering=e.getNetFilteringSwitch(this.rawURL)),this.netFilteringReadTime=Date.now(),this.netFiltering)};var u,c=function(e,o){var s=t[e];return void 0===s&&(s=new h(e)).autodestroy(),s.push(o),i=o,n=Date.now(),s},l=function(e){return t[e]||null};(u=new h(vAPI.noTabId)).stack.push(new a("",!0)),u.rawURL="",u.normalURL=e.normalizePageURL(u.tabId),u.rootHostname=e.URI.hostnameFromURI(u.normalURL),u.rootDomain=e.URI.domainFromHostname(u.rootHostname);var m=[],d=function(t){this.init(t)};d.prototype.init=function(t){var e=l(t);return this.rootHostname=e.rootHostname,this.rootDomain=e.rootDomain,this.pageHostname=this.pageDomain=this.requestURL=this.requestHostname=this.requestDomain="",this},d.prototype.dispose=function(){m.push(this)};return{push:c,commit:function(e,i){var n=t[e];return void 0===n?n=c(e,i):(n.commit(i),r(e)),n},lookup:l,mustLookup:function(e){var o=t[e];return void 0!==o?o:(""!==i&&n+500<Date.now()&&(i=""),""!==i?c(e,i):t[vAPI.noTabId])},exists:function(e){return void 0!==t[e]},createContext:function(t){return m.length?m.pop().init(t):new d(t)}}}(),vAPI.tabs.onPopupUpdated=function(t,i){var n=e.tabContextManager.lookup(i);if(null!==n){var o=n.rawURL;if(""!==o&&null!==(n=e.tabContextManager.lookup(t))&&""!==n.rawURL&&!1!==e.getNetFilteringSwitch(e.normalizePageURL(i,o)))return!0}},vAPI.tabs.registerListeners(),e.bindTabToPageStats=function(t,i){if(!1===e.tabContextManager.exists(t))return this.unbindTabFromPageStats(t),null;var n=this.pageStores[t];return n?vAPI.isBehindTheSceneTabId(t)?n:"beforeRequest"===i?n:(n.reuse(i),this.updateTitle(t),this.pageStoresToken=Date.now(),n):(this.updateTitle(t),this.pageStoresToken=Date.now(),this.pageStores[t]=this.PageStore.factory(t))},e.unbindTabFromPageStats=function(t){var e=this.pageStores[t];void 0!==e&&(e.dispose(),delete this.pageStores[t],this.pageStoresToken=Date.now())},e.pageStoreFromTabId=function(t){return this.pageStores[t]||null},e.mustPageStoreFromTabId=function(t){return this.pageStores[t]||this.pageStores[vAPI.noTabId]},e.pageStores[vAPI.noTabId]=e.PageStore.factory(vAPI.noTabId),e.pageStores[vAPI.noTabId].title=vAPI.i18n("logBehindTheScene"),e.updateBadgeAsync=(t=Object.create(null),function(e){t[e]||vAPI.isBehindTheSceneTabId(e)||(t[e]=vAPI.setTimeout(function(e){delete t[e];var i=!1,n="",o=this.pageStoreFromTabId(e);null!==o&&(i=o.getNetFilteringSwitch())&&this.userSettings.showIconBadge&&o.perLoadBlockedRequestCount&&(n=this.formatCount(o.perLoadBlockedRequestCount)),vAPI.setIcon(e,i?"on":"off",n)}.bind(this,e),666))}),e.updateTitle=function(){var t=Object.create(null),i=Object.create(null),n=function(t){delete i[t]},o=function(n){var o=i[n];return void 0!==o&&(1===o?(delete i[n],!1):(i[n]=o-1,t[n]=vAPI.setTimeout(s.bind(e,n),499),!0))},s=function(e){delete t[e],vAPI.tabs.get(e,function(t,e){if(!e)return n(t);var i=this.pageStoreFromTabId(t);if(null===i)return n(t);if(i.rawURL=e.url,this.pageStoresToken=Date.now(),e.title||!o(t)){var s=e.title&&e.title===i.title;i.title=e.title||e.url||"",this.pageStoresToken=Date.now(),!s&&o(t)||n(t)}}.bind(this,e))};return function(e){vAPI.isBehindTheSceneTabId(e)||(t[e]&&clearTimeout(t[e]),t[e]=vAPI.setTimeout(s.bind(this,e),499),i[e]=5)}}();var i=0,n=function(){var t,o=vAPI.tabs,s=Object.keys(e.pageStores).sort(),r=function(t){o.get(t,function(i){i||e.unbindTabFromPageStats(t)})};i>=s.length&&(i=0);for(var a=Math.min(i+10,s.length),h=i;h<a;h++)t=s[h],vAPI.isBehindTheSceneTabId(t)||r(t);i=a,vAPI.setTimeout(n,9e5)};vAPI.setTimeout(n,9e5)}();